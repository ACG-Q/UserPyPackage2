name: Python Package Automation

on:
  issues:
    types: [opened, edited]

env:
  # ÊûÑÂª∫Áõ∏ÂÖ≥
  BUILD_DIR: ./src
  DIST_DIR: ./src/dist
  ARTIFACT_DIR: artifacts
  
  # Âπ≥Âè∞Áõ∏ÂÖ≥
  VALID_PLATFORMS: '["ubuntu-latest", "macos-latest", "windows-latest"]'
  
  # ÈÖçÁΩÆÁõ∏ÂÖ≥
  REQUIRED_FIELDS: '["name", "version", "platform", "python_version"]'
  
  # ÂàÜÊîØÁõ∏ÂÖ≥
  SOURCE_BRANCH_PREFIX: source-
  
  # ÊûÑÂª∫‰∫ßÁâ©Áõ∏ÂÖ≥
  ARTIFACT_NAME_PREFIX: python-package-

jobs:
  precheck:
    if: >
      contains(github.event.issue.labels.*.name, 'packaging-request') &&
      contains(github.event.issue.labels.*.name, 'ABC')
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.parse-config.outputs.platforms }}
      config_data: ${{ steps.parse-config.outputs.config_data }}
      has_attachments: ${{ steps.check-attachments.outputs.has_attachments }}
      issue_number: ${{ github.event.issue.number }}
      source_branch: ${{ env.SOURCE_BRANCH_PREFIX }}${{ github.event.issue.number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check attachments
        id: check-attachments
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            // Ëß£Êûêissue body‰∏≠ÁöÑÈôÑ‰ª∂
            const zipPattern = /\[.*?\]\((.*?\.zip)\)/;
            const jsonPattern = /\[.*?\]\((.*?\.json)\)/;
            
            const zipMatch = body.match(zipPattern);
            const jsonMatch = body.match(jsonPattern);
            
            const hasAttachments = zipMatch && jsonMatch;
            
            if (hasAttachments) {
              core.setOutput('source_url', zipMatch[1]);
              core.setOutput('config_url', jsonMatch[1]);
            }
            
            core.setOutput('has_attachments', hasAttachments ? 'true' : 'false');
            
            // Â¶ÇÊûúÁº∫Â∞ëÈôÑ‰ª∂ÔºåÂèëË°®ËØÑËÆ∫
            if (!hasAttachments) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚ùå Áº∫Â∞ëÂøÖË¶ÅÁöÑÈôÑ‰ª∂Êñá‰ª∂(source.zipÂíåpython-config.json)'
              });
            }

      - name: Parse and validate config
        id: parse-config
        if: steps.check-attachments.outputs.has_attachments == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const configUrl = '${{ steps.check-attachments.outputs.config_url }}';
            
            // ‰∏ãËΩΩÈÖçÁΩÆÊñá‰ª∂
            const response = await fetch(configUrl);
            const config = await response.json();
            
            // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
            const requiredFields = JSON.parse(process.env.REQUIRED_FIELDS);
            const missingFields = requiredFields.filter(field => !config[field]);
            
            if (missingFields.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå ÈÖçÁΩÆÊñá‰ª∂Áº∫Â∞ëÂøÖÂ°´Â≠óÊÆµ: ${missingFields.join(', ')}`
              });
              core.setFailed('Missing required fields');
              return;
            }
            
            // Âú® parse-config step ‰∏≠Ê∑ªÂä†Êõ¥‰∏•Ê†ºÁöÑÂ≠óÊÆµÈ™åËØÅ
            const validateFields = {
              // Á®ãÂ∫èÂêçÁß∞: Âè™ÂÖÅËÆ∏Â≠óÊØçÊï∞Â≠ó‰∏ãÂàíÁ∫øÂíåÊ®™Á∫ø
              name: value => typeof value === 'string' && /^[a-zA-Z0-9_-]+$/.test(value),
              
              // ÁâàÊú¨Âè∑: Ê†áÂáÜÁöÑËØ≠‰πâÂåñÁâàÊú¨Ê†ºÂºè
              version: value => typeof value === 'string' && /^\d+\.\d+\.\d+$/.test(value),
              
              // Âπ≥Âè∞: ÂøÖÈ°ªÊòØÊï∞ÁªÑ‰∏îÂè™ËÉΩÂåÖÂê´ÊîØÊåÅÁöÑÂπ≥Âè∞
              platform: value => {
                const validPlatforms = JSON.parse(process.env.VALID_PLATFORMS);
                return Array.isArray(value) && value.length > 0 && 
                      value.every(p => validPlatforms.includes(p));
              },
              
              // PythonÁâàÊú¨: Ê†áÂáÜÁöÑPythonÁâàÊú¨Ê†ºÂºè
              python_version: value => typeof value === 'string' && 
                                    /^\d+\.\d+(\.\d+)?$/.test(value),
              
              // ‰æùËµñÈ°π: ÂøÖÈ°ªÊòØÊï∞ÁªÑÔºåÊØèÈ°πÂøÖÈ°ªÁ¨¶ÂêàÂåÖÂêçÊ†ºÂºè
              dependencies: value => !value || (Array.isArray(value) && 
                            value.every(dep => /^[a-zA-Z0-9_-]+(?:==\d+\.\d+\.\d+)?$/.test(dep))),
              
              // ÊèèËø∞: ÂèØÈÄâÔºåÂøÖÈ°ªÊòØÂ≠óÁ¨¶‰∏≤
              description: value => !value || typeof value === 'string',
              
              // ÊûÑÂª∫Áõ∏ÂÖ≥ËÑöÊú¨: ÂøÖÈ°ªÊòØÂ≠óÁ¨¶‰∏≤Ôºå‰∏îÂ¶ÇÊûúÊòØÊñá‰ª∂ÂøÖÈ°ªÊúâÊ≠£Á°ÆÁöÑÊâ©Â±ïÂêç
              pre_build: value => !value || (typeof value === 'string' && 
                          (!value.includes('.') || /\.(py|sh)$/.test(value))),
              
              build: value => typeof value === 'string' && 
                      (!value.includes('.') || /\.(py|sh)$/.test(value)),
              
              post_build: value => !value || (typeof value === 'string' && 
                          (!value.includes('.') || /\.(py|sh)$/.test(value)))
            };

            // È™åËØÅÂ≠óÊÆµÂπ∂ÁîüÊàêËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
            const errors = [];
            for (const [field, validator] of Object.entries(validateFields)) {
              if (config[field] !== undefined && !validator(config[field])) {
                let errorMsg = `Â≠óÊÆµ "${field}" ÁöÑÂÄºÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ`;
                switch (field) {
                  case 'name':
                    errorMsg += 'Âè™ÂÖÅËÆ∏‰ΩøÁî®Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÂíåÊ®™Á∫ø„ÄÇ';
                    break;
                  case 'version':
                    errorMsg += 'ÂøÖÈ°ªÊòØÊúâÊïàÁöÑËØ≠‰πâÂåñÁâàÊú¨Âè∑ (‰æãÂ¶Ç: 1.0.0)„ÄÇ';
                    break;
                  case 'platform':
                    errorMsg += `ÂøÖÈ°ªÊòØÊï∞ÁªÑÔºå‰∏îÂè™ËÉΩÂåÖÂê´‰ª•‰∏ãÂÄº: ${process.env.VALID_PLATFORMS}`;
                    break;
                  case 'python_version':
                    errorMsg += 'ÂøÖÈ°ªÊòØÊúâÊïàÁöÑPythonÁâàÊú¨Âè∑ (‰æãÂ¶Ç: 3.9.13)„ÄÇ';
                    break;
                  case 'dependencies':
                    errorMsg += 'ÂøÖÈ°ªÊòØÂåÖÂêçÊï∞ÁªÑÔºåÂèØÈÄâÊåáÂÆöÁâàÊú¨Âè∑ (‰æãÂ¶Ç: ["requests==2.31.0", "numpy"])„ÄÇ';
                    break;
                  default:
                    if (field.endsWith('build')) {
                      errorMsg += 'ÂøÖÈ°ªÊòØÊúâÊïàÁöÑÂëΩ‰ª§Êàñ.py/.shËÑöÊú¨Ë∑ØÂæÑ„ÄÇ';
                    }
                }
                errors.push(errorMsg);
              }
            }

            if (errors.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå ÈÖçÁΩÆÈ™åËØÅÂ§±Ë¥•:\n\n${errors.join('\n')}`
              });
              core.setFailed('Invalid configuration');
              return;
            }
            
            // È™åËØÅÂπ≥Âè∞ÂÄº
            const validPlatforms = JSON.parse(process.env.VALID_PLATFORMS);
            const invalidPlatforms = config.platform.filter(p => !validPlatforms.includes(p));
            
            if (invalidPlatforms.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå ‰∏çÊîØÊåÅÁöÑÂπ≥Âè∞: ${invalidPlatforms.join(', ')}\nÊîØÊåÅÁöÑÂπ≥Âè∞: ${validPlatforms.join(', ')}`
              });
              core.setFailed('Invalid platforms');
              return;
            }
            
            // ËæìÂá∫ÈÖçÁΩÆ‰ø°ÊÅØ
            core.setOutput('config_data', JSON.stringify(config));
            core.setOutput('platforms', JSON.stringify(config.platform));

      - name: Create source branch
        if: steps.check-attachments.outputs.has_attachments == 'true'
        run: |
          git checkout -b ${{ env.SOURCE_BRANCH_PREFIX }}${{ github.event.issue.number }}
          curl -L ${{ steps.check-attachments.outputs.source_url }} -o source.zip
          curl -L ${{ steps.check-attachments.outputs.config_url }} -o python-config.json
          mkdir -p ${{ env.BUILD_DIR }}
          unzip source.zip -d ${{ env.BUILD_DIR }}
          git add .
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Add source files for issue #${{ github.event.issue.number }}"
          git push origin ${{ env.SOURCE_BRANCH_PREFIX }}${{ github.event.issue.number }}

  build:
    needs: precheck
    if: needs.precheck.outputs.has_attachments == 'true'
    strategy:
      matrix:
        platform: ${{ fromJSON(needs.precheck.outputs.platforms) }}
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v3
        with:
          ref: ${{ needs.precheck.outputs.source_branch }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ fromJSON(needs.precheck.outputs.config_data).python_version }}
          cache: 'pip'

      - name: Run pre-build script
        if: fromJson(needs.precheck.outputs.config_data).pre_build
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          PRE_BUILD="${{ fromJson(needs.precheck.outputs.config_data).pre_build }}"
          if [[ $PRE_BUILD == *.py ]]; then
            python "$PRE_BUILD"
          elif [[ $PRE_BUILD == *.sh ]]; then
            chmod +x "$PRE_BUILD"
            ./"$PRE_BUILD"
          else
            eval "$PRE_BUILD"
          fi

      - name: Build package
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # ÂÆâË£Ö‰æùËµñ
          python -m pip install build
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            if [ -n "${{ fromJSON(needs.precheck.outputs.config_data).dependencies }}" ]; then
              pip install ${{ join(fromJSON(needs.precheck.outputs.config_data).dependencies, ' ') }}
            fi
          fi
          
          # ÊâßË°åbuildÂëΩ‰ª§
          BUILD_CMD=${{ fromJSON(needs.precheck.outputs.config_data).build }}
          if [[ $BUILD_CMD == *.py ]]; then
            python "$BUILD_CMD"
          elif [[ $BUILD_CMD == *.sh ]]; then
            chmod +x "$BUILD_CMD"
            ./"$BUILD_CMD"
          else
            eval "$BUILD_CMD"
          fi

      - name: Run post-build script
        if: fromJson(needs.precheck.outputs.config_data).post_build
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          POST_BUILD="${{ fromJson(needs.precheck.outputs.config_data).post_build }}"
          if [[ $POST_BUILD == *.py ]]; then
            python "$POST_BUILD"
          elif [[ $POST_BUILD == *.sh ]]; then
            chmod +x "$POST_BUILD"
            ./"$POST_BUILD"
          else
            eval "$POST_BUILD"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.ARTIFACT_NAME_PREFIX }}${{ matrix.platform }}
          path: ${{ env.DIST_DIR }}/*

  release:
    needs: [precheck, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: ${{ env.ARTIFACT_DIR }}
      
      - name: Create release body
        id: create-release-body
        uses: actions/github-script@v6
        env:
          description: ${{ fromJSON(needs.precheck.outputs.config_data).description }}
          platform: ${{ fromJSON(needs.precheck.outputs.config_data).platform }}
        with:
          script: |
            let description = process.env.description ?? "No description provided";
            let platforms = ','.join(process.env.platform ?? []);
            
            // {description}
            // 
            // ---
            // Built for platforms: {platforms}
            let body = description + "\n\n---\nBuilt for platforms: " + platforms

            core.setOutput('body', JSON.stringify(body));


      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ fromJSON(needs.precheck.outputs.config_data).name }}-${{ fromJSON(needs.precheck.outputs.config_data).version }}
          body: ${{ steps.create-release-body.outputs.body }}
          files: |
            ${{ env.ARTIFACT_DIR }}/**/*

  notify:
    needs: [release, precheck]
    runs-on: ubuntu-latest
    steps:
      - name: Update Issue
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ needs.precheck.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "üöÄ Build completed successfully!\n\n" +
                    "üì¶ Release: https://github.com/${{ github.repository }}/releases/tag/${{ fromJSON(needs.precheck.outputs.config_data).name }}-${{ fromJSON(needs.precheck.outputs.config_data).version }}"
            })

  cleanup:
    if: always()
    needs: [release]
    runs-on: ubuntu-latest
    steps:
      - name: Clean workspace
        run: |
          rm -rf src/ artifacts/
